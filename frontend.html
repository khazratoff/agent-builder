<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Chat System</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: #fff;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #333;
        }

        .dark-mode-toggle {
            background: #333;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .dark-mode-toggle:hover {
            background: #555;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.agent {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #007bff;
            color: white;
        }

        .message.agent .message-avatar {
            background: #6c757d;
            color: white;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* Markdown styles in agent messages */
        .message.agent .message-content {
            line-height: 1.6;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3 {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message-content li {
            margin: 0.25rem 0;
        }

        .message-content p {
            margin: 0.5rem 0;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content em {
            font-style: italic;
        }

        body.dark-mode .message-content code {
            background: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .message-content pre {
            background: rgba(255, 255, 255, 0.1);
        }

        .message.user .message-content {
            background: #007bff;
            color: white;
        }

        .message.agent .message-content {
            background: #f0f0f0;
            color: #333;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Input Area */
        .input-area {
            padding: 1.5rem;
            background: #fff;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .input-container input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-container input:focus {
            border-color: #007bff;
        }

        .input-container button {
            padding: 0.75rem 2rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .input-container button:hover:not(:disabled) {
            background: #0056b3;
        }

        .input-container button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #fff;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .sidebar h2 {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #007bff;
        }

        .agent-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .agent-card.active {
            border-color: #007bff;
            background: #e7f3ff;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(0, 123, 255, 0.5);
            }
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .agent-icon {
            font-size: 1.5rem;
        }

        .agent-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .agent-status {
            margin-left: auto;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            background: #28a745;
            color: white;
        }

        .agent-card.active .agent-status {
            background: #007bff;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .agent-description {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .agent-capabilities {
            list-style: none;
            font-size: 0.8rem;
            color: #777;
        }

        .agent-capabilities li {
            padding: 0.25rem 0;
        }

        .agent-capabilities li:before {
            content: "‚Ä¢ ";
            color: #007bff;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            border: 1px solid #f5c6cb;
        }

        /* Dark Mode */
        body.dark-mode {
            background: #1a1a1a;
        }

        body.dark-mode .header,
        body.dark-mode .chat-area,
        body.dark-mode .sidebar,
        body.dark-mode .input-area {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .header {
            border-bottom-color: #444;
        }

        body.dark-mode .sidebar {
            border-left-color: #444;
        }

        body.dark-mode .input-area {
            border-top-color: #444;
        }

        body.dark-mode .header h1,
        body.dark-mode .sidebar h2,
        body.dark-mode .agent-name {
            color: #e0e0e0;
        }

        body.dark-mode .message.agent .message-content {
            background: #3d3d3d;
            color: #e0e0e0;
        }

        body.dark-mode .agent-card {
            background: #3d3d3d;
            border-color: #555;
        }

        body.dark-mode .agent-card.active {
            background: #1e3a5f;
            border-color: #007bff;
        }

        body.dark-mode .input-container input {
            background: #3d3d3d;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .dark-mode-toggle {
            background: #e0e0e0;
            color: #333;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                right: -300px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: right 0.3s;
            }

            .sidebar.open {
                right: 0;
            }

            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ Multi-Agent Chat System</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Chat Area -->
            <div class="chat-area">
                <div class="messages" id="messages">
                    <!-- Messages will be inserted here -->
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span id="typingText">Agent is thinking...</span>
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <input
                            type="text"
                            id="messageInput"
                            placeholder="Type your message here..."
                            onkeypress="handleKeyPress(event)"
                        />
                        <button onclick="sendMessage()" id="sendButton">Send</button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <h2>Available Agents</h2>
                <div id="agentsList">
                    <!-- Agents will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const THREAD_ID = 'web_session_' + Date.now();

        // Agent icon mapping
        const agentIcons = {
            'file_operations': 'üìÅ',
            'research': 'üîç',
            'weather': 'üå§Ô∏è'
        };

        // State
        let isStreaming = false;
        let currentAgentName = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Configure marked.js for better markdown rendering
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });
            }

            loadAgents();
            focusInput();
        });

        // Load agents from API
        async function loadAgents() {
            try {
                const response = await fetch(`${API_BASE_URL}/agents`);
                const data = await response.json();

                const agentsList = document.getElementById('agentsList');
                agentsList.innerHTML = '';

                data.agents.forEach(agent => {
                    const icon = agentIcons[agent.name] || 'ü§ñ';
                    const capabilities = agent.capabilities.slice(0, 4);

                    const card = document.createElement('div');
                    card.className = 'agent-card';
                    card.id = `agent-${agent.name}`;
                    card.innerHTML = `
                        <div class="agent-header">
                            <span class="agent-icon">${icon}</span>
                            <span class="agent-name">${formatAgentName(agent.name)}</span>
                            <span class="agent-status">Idle</span>
                        </div>
                        <div class="agent-description">${agent.description}</div>
                        <ul class="agent-capabilities">
                            ${capabilities.map(cap => `<li>${cap}</li>`).join('')}
                            ${agent.capabilities.length > 4 ? `<li>... and ${agent.capabilities.length - 4} more</li>` : ''}
                        </ul>
                    `;
                    agentsList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading agents:', error);
                showError('Failed to load agents. Please ensure the server is running.');
            }
        }

        // Format agent name
        function formatAgentName(name) {
            return name.split('_').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || isStreaming) return;

            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            showTypingIndicator();
            isStreaming = true;
            updateSendButton(false);

            try {
                // Call streaming API
                const response = await fetch(`${API_BASE_URL}/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        thread_id: THREAD_ID
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Read stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let agentMessage = '';
                let messageElement = null;
                let detectedAgent = false;

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    const chunk = decoder.decode(value);

                    // Check for agent metadata
                    if (!detectedAgent && chunk.includes('__AGENT__:')) {
                        const match = chunk.match(/__AGENT__:(\w+)/);
                        if (match) {
                            const agentName = match[1];
                            setActiveAgent(agentName);
                            detectedAgent = true;
                            // Remove the metadata from the chunk
                            continue;
                        }
                    }

                    agentMessage += chunk;

                    // Create or update message element
                    if (!messageElement) {
                        messageElement = addMessage('', 'agent', true);
                        hideTypingIndicator();
                    }

                    // Update message content with streaming text (render as markdown)
                    const contentDiv = messageElement.querySelector('.message-content');
                    contentDiv.innerHTML = marked.parse(agentMessage);

                    // Auto scroll
                    scrollToBottom();
                }

            } catch (error) {
                console.error('Error streaming message:', error);
                hideTypingIndicator();
                showError('Failed to get response. Please check if the server is running.');
            } finally {
                isStreaming = false;
                updateSendButton(true);
                resetAgentStatus();
                focusInput();
            }
        }

        // Add message to chat
        function addMessage(text, type, isStreaming = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'üë§' : 'ü§ñ';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesDiv.appendChild(messageDiv);

            if (!isStreaming) {
                scrollToBottom();
            }

            return messageDiv;
        }

        // Show typing indicator
        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('active');
            // Don't set active agent here - wait for actual agent info from stream
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        // Set active agent
        function setActiveAgent(agentName) {
            // Remove active from all
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('active');
                card.querySelector('.agent-status').textContent = 'Idle';
            });

            // Set active
            const card = document.getElementById(`agent-${agentName}`);
            if (card) {
                card.classList.add('active');
                card.querySelector('.agent-status').textContent = '‚ö° Active';
                currentAgentName = agentName;
            }
        }

        // Reset agent status
        function resetAgentStatus() {
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('active');
                card.querySelector('.agent-status').textContent = 'Idle';
            });
            currentAgentName = null;
        }

        // Update send button state
        function updateSendButton(enabled) {
            const button = document.getElementById('sendButton');
            button.disabled = !enabled;
            button.textContent = enabled ? 'Send' : 'Sending...';
        }

        // Show error
        function showError(message) {
            const messagesDiv = document.getElementById('messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = '‚ö†Ô∏è ' + message;
            messagesDiv.appendChild(errorDiv);
            scrollToBottom();
        }

        // Scroll to bottom
        function scrollToBottom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Focus input
        function focusInput() {
            document.getElementById('messageInput').focus();
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const button = document.querySelector('.dark-mode-toggle');
            if (document.body.classList.contains('dark-mode')) {
                button.textContent = '‚òÄÔ∏è Light Mode';
            } else {
                button.textContent = 'üåô Dark Mode';
            }
        }
    </script>
</body>
</html>
